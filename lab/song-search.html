<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vyhledávání písní</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        color: #2d5a2d;
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        margin-bottom: 10px;
        font-weight: 600;
      }

      .header p {
        color: #5a7a5a;
        font-size: clamp(1rem, 2vw, 1.1rem);
      }

      .search-container {
        position: relative;
        margin-bottom: 30px;
        width: 66.666%;
        margin-left: auto;
        margin-right: auto;
      }

 .search-input {
            width: 100%;
            padding: 18px 24px;
            font-size: clamp(1rem, 2vw, 1.2rem);
            border: 3px solid #c4d9c4;
            border-radius: 16px;
            background: #ffffff;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(45, 90, 45, 0.1);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 48px;
        }

      .search-input:focus {
        border-color: #ff9966;
        box-shadow: 0 0 0 4px rgba(255, 153, 102, 0.2),
          0 4px 12px rgba(45, 90, 45, 0.15);
        transform: translateY(-1px);
      }

      .search-input::placeholder {
        color: #8fb48f;
      }

 .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 3px solid #c4d9c4;
            border-top: none;
            border-radius: 0 0 16px 16px;
            max-height: calc(84px * 5);
            overflow-y: auto; /* remains scrollable when more than 5 results */
            overflow-x: hidden;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 24px rgba(45, 90, 45, 0.15);
            /* visually hide scrollbar while keeping scrolling usable */
            -ms-overflow-style: none; /* IE 10+ */
            scrollbar-width: none; /* Firefox */
        }
        .search-results::-webkit-scrollbar { display: none; }
        .search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #7a9a7a;
            padding: 6px 8px;
        }
        .search-clear:focus { outline: none; }

      .search-result-item {
        padding: 18px 24px;
        min-height: 56px;
        cursor: pointer;
        border-bottom: 1px solid #f0f8f0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        color: #2d5a2d;
        font-size: 1rem;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .search-result-item:hover,
      .search-result-item.selected {
        background: linear-gradient(135deg, #ff9966, #ffb399);
        color: white;
        transform: translateX(4px);
      }

      .search-result-item:hover small,
      .search-result-item.selected small {
        color: rgba(255, 255, 255, 0.8) !important;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .song-details {
        background: #ffffff;
        border: 3px solid #c4d9c4;
        border-radius: 16px;
        padding: 24px;
        min-height: 200px;
        box-shadow: 0 4px 16px rgba(45, 90, 45, 0.1);
        transition: all 0.3s ease;
      }

      .song-details:hover {
        box-shadow: 0 6px 20px rgba(45, 90, 45, 0.15);
      }

      .song-details h2 {
        color: #2d5a2d;
        margin-bottom: 5px;
        font-size: clamp(1.2rem, 3vw, 1.5rem);
        font-weight: 600;
      }

      .song-lyrics {
        background: #ffffff;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        line-height: 1.6;
        color: #2d5a2d;
        white-space: pre-line;
        text-align: left;
      }

      .no-results {
        text-align: center;
        color: #7a9a7a;
        font-style: italic;
        padding: 60px 20px;
        font-size: clamp(1rem, 2vw, 1.1rem);
      }

      @media (max-width: 768px) {
        body {
          padding: 15px;
        }

        .container {
          max-width: 100%;
        }

        .search-container {
          width: 100%;
          margin-left: 0;
          margin-right: 0;
        }

        .search-input {
          padding: 15px 20px;
        }

        .search-result-item {
          padding: 14px 20px;
        }

        .song-details {
          padding: 20px;
        }

        .song-lyrics {
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .header {
          margin-bottom: 30px;
        }

        .search-input {
          padding: 12px 16px;
        }

        .search-result-item {
          padding: 12px 16px;
        }

        .song-details {
          padding: 16px;
        }

        /* Stack playlist and preview on very small screens only */
        .main-grid { grid-template-columns: 1fr !important; gap: 12px; }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .search-results {
        animation: fadeIn 0.3s ease;
      }

      .search-input:focus-visible {
        outline: 3px solid #ff9966;
        outline-offset: 2px;
      }

      .search-result-item:focus {
        outline: 2px solid #ff9966;
        outline-offset: -2px;
      }

      /* Playlist & two-column layout */
      .main-grid {
        display: grid;
        grid-template-columns: minmax(240px, 1fr) 2fr;
        gap: 20px;
        align-items: start;
        margin-top: 20px;
      }

      .playlist-panel {
        width: 100%;
      }

      .right-panel {
        width: 100%;
      }

      .playlist-manager {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
      }

      /* compact overlay: title over select */
      .playlist-compact { display:flex; align-items:center; gap:8px; }
      /* Playlist combo: a single component combining title (editable) and native select */
      .playlist-combo { position:relative; display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; }
      .playlist-combo #playlistTitle { position:relative; z-index:3; background:transparent; color:#2d5a2d; font-weight:600; padding:4px 6px; border-radius:6px; }
      /* native select is kept but hidden when closed; when opened it becomes a native dropdown below the component */
      .playlist-combo select {
        position:absolute;
        left:0;
        top:100%;
        width:100%;
        margin-top:8px;
        display:block;
        opacity:0;
        pointer-events:none;
        z-index:2;
        max-height:240px;
        overflow:auto;
        border-radius:8px;
        border:1px solid #c4d9c4;
        background:#fff;
        color:#2d5a2d;
      }
      .playlist-combo select[data-temp-open="true"] { opacity:1; pointer-events:auto; box-shadow:0 8px 24px rgba(45,90,45,0.12); }
      /* transparent small toggle inside the same component */
      .playlist-combo .toggle-btn { background:transparent; color:#2d5a2d; width:28px; height:28px; padding:4px; border-radius:6px; }
      .playlist-combo .toggle-btn svg { display:block; }

      .playlist-actions { display:flex; gap:6px; align-items:center; }

      .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:6px; border:none; background:#2d5a2d; color:#fff; cursor:pointer; padding:4px; }
      /* Ensure SVG icons inherit the button color so strokes/fills are visible on colored backgrounds */
      .icon-btn svg { display:block; color: inherit; width: 100%; height: 100%; }
      .icon-btn svg path, .icon-btn svg circle, .icon-btn svg rect { stroke: currentColor !important; fill: currentColor !important; }
      .icon-btn:focus { outline:2px solid #ff9966; }

      .playlist-manager select {
        flex: 1 1 auto;
        padding: 8px 10px;
        border-radius: 8px;
        border: 2px solid #c4d9c4;
        background: #fff;
      }

      .playlist-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .playlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .playlist-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #playlistTitle {
        font-size: 1rem;
        font-weight: 600;
        color: #2d5a2d;
        padding: 6px 8px;
        border-radius: 8px;
        min-width: 0;
        outline: none;
        border: 2px solid transparent;
        display: inline-block;
      }

      /* When editing, add visible focus ring to contenteditable title */
      .playlist-header.editing #playlistTitle {
        box-shadow: 0 0 0 4px rgba(255,153,102,0.12);
        border-color: #ff9966;
      }

      #playlistTitle[contenteditable] {
        padding: 6px 8px;
        border-radius: 8px;
      }

      #playlistTitle[contenteditable]:focus {
        outline: 2px solid #ff9966;
      }

      #ariaLive {
        position: absolute;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      

      .playlist-items {
        background: #ffffff;
        border: 3px solid #c4d9c4;
        border-radius: 12px;
        /* Allow playlist to grow vertically as items are added */
        max-height: none;
        overflow: visible;
      }

      /* If you later enable scrolling, keep the scrollbar visually minimal */
      .playlist-items::-webkit-scrollbar { height: 8px; }
      .playlist-items { -ms-overflow-style: auto; scrollbar-width: auto; }

      .playlist-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-bottom: 1px solid #f0f8f0;
        gap: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
      }

      .drag-handle {
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        color: #7a9a7a;
        cursor: grab;
        user-select: none;
      }

.dragging { opacity: 0.6; }

      /* Visual drop indicators */
      .playlist-item.drop-before::before,
      .playlist-item.drop-after::after {
        content: "";
        position: absolute;
        left: 12px;
        right: 12px;
        height: 3px;
        background: linear-gradient(90deg, #ff9966, #ffb399);
        border-radius: 2px;
        pointer-events: none;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      }
      .playlist-item.drop-before::before { top: 0; transform: translateY(-50%); }
      .playlist-item.drop-after::after { bottom: 0; transform: translateY(50%); }

      /* Sonar bounce when item was moved */
      @keyframes sonar {
        0% { box-shadow: 0 0 0 0 rgba(255,153,102,0.25); }
        70% { box-shadow: 0 0 0 18px rgba(255,153,102,0.0); }
        100% { box-shadow: 0 0 0 0 rgba(255,153,102,0); }
      }
      .playlist-item.moved {
        animation: sonar 700ms ease-out;
      }

      .playlist-item a {
        color: #2d5a2d;
        text-decoration: none;
        flex: 1 1 auto;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
      }

      .playlist-item small {
        display: block;
        color: #7a9a7a;
        font-size: 0.85em;
      }

      .playlist-item button.remove-item {
        margin-left: 8px;
        background: transparent;
        border: none;
        color: #7a9a7a;
        cursor: pointer;
        font-size: 16px;
      }

      .playlist-item small {
        display: block;
        color: #7a9a7a;
        font-size: 0.85em;
      }

      .playlist-item button.remove-item {
        margin-left: 8px;
        background: transparent;
        border: none;
        color: #7a9a7a;
        cursor: pointer;
        font-size: 16px;
      }


    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🎵 Vyhledávání písní</h1>
      </div>

            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Zadejte alespoň 2 znaky pro vyhledání písní..."
                    autocomplete="off"
                    autofocus
                >
                <button id="searchClearBtn" class="search-clear" aria-label="Vymazat hledání"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                <div id="searchResults" class="search-results"></div>
            </div>

        <div class="playlist-controls">


          <div class="playlist-header" id="playlistHeader">
              <div class="playlist-title-row">
                <div class="playlist-combo" style="margin-right:8px; border:2px solid transparent;" role="group" aria-label="Playlist selector">
                  <div id="playlistTitle" contenteditable="plaintext-only" role="textbox" aria-label="Název playlistu">Nový playlist</div>
                  <select id="playlistSelect" aria-label="Vybrat playlist"> </select>
                  <button id="openPlaylistSelectBtn" class="toggle-btn" title="Otevřít playlisty" aria-label="Otevřít playlisty" aria-haspopup="listbox" aria-expanded="false" aria-controls="playlistSelect">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
                <div class="playlist-actions">
                  <button id="newPlaylistBtn" class="icon-btn" title="Nový playlist" aria-label="Nový playlist">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                  <button id="deletePlaylistBtn" class="icon-btn" title="Smazat playlist" aria-label="Smazat playlist">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M9 3h6l1 2h3v2H5V5h3l1-2z" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </button>
                </div>
              </div>
            <div>
              <button id="clearPlaylistBtn" class="icon-btn" title="Vyprázdnit playlist" aria-label="Vyprázdnit playlist">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M8 6h8M6 10h12M8 14h8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
            <div id="ariaLive" aria-live="polite" aria-atomic="true"></div>
          </div>
        </div>

        <div class="main-grid">
          <div class="playlist-panel">
            <div id="playlistItems" class="playlist-items">
              <!-- playlist entries go here -->
            </div>
          </div>

          <div class="right-panel">
            <div class="song-details">
              <h2 id="songDetailsTitle">Detail písně</h2>
              <div id="songDetailsContent" class="no-results">
                Vyberte píseň z výsledků vyhledávání pro zobrazení detailů
              </div>
            </div>
          </div>
        </div>
    </div>

    <script>
      // Songs, index and search state
      let songsData = {};
      let songIndex = {};
      let searchTimeout = null;
      let selectedIndex = -1;
      let currentResults = [];
      let dragSrcIndex = null;
      let lastMovedKey = null;

      // Playlist state
      const PLAYLISTS_KEY = 'song_lab_playlists_v1';
      let playlists = {}; // id -> { id, name, items: [{title, firstLine, songKey}] }
      let currentPlaylistId = null;

      function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }

      async function loadSongsData() {
        try {
          const response = await fetch('songs.json');
          songsData = await response.json();

          songIndex = {};
          Object.keys(songsData).forEach((title) => {
            const firstLine = getFirstLine(songsData[title]);
            songIndex[title] = {
              title: title,
              displayTitle: cleanTitleForDisplay(title),
              firstLine: firstLine,
              titleTrigrams: createPostgresStyleTrigrams(title),
              firstLineTrigrams: createPostgresStyleTrigrams(firstLine),
              data: songsData[title]
            };
          });

          console.log('Songs data loaded:', Object.keys(songsData).length);
        } catch (err) {
          console.error('Error loading songs.json', err);
          document.getElementById('songDetailsContent').innerHTML = '<div class="no-results">Chyba při načítání dat písní. Zkontrolujte, zda existuje soubor songs.json.</div>';
        }
      }

      function normalizeText(text) {
        return removeAccents(text || '').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
      }

      function cleanTitleForDisplay(title) {
        const idx = title.indexOf(';');
        if (idx !== -1) return title.substring(0, idx).trim();
        return title;
      }

      function getFirstLine(songData) {
        if (!songData) return '';
        if (!songData.sections || !Array.isArray(songData.sections) || songData.sections.length === 0) return '';
        const firstSection = songData.sections[0];
        if (!firstSection.slides || !Array.isArray(firstSection.slides) || firstSection.slides.length === 0) return '';
        const firstSlide = firstSection.slides[0];
        if (!Array.isArray(firstSlide) || firstSlide.length === 0) return '';
        return firstSlide[0];
      }

      function createPostgresStyleTrigrams(text) {
        const normalized = normalizeText(text);
        const padded = '  ' + normalized + ' ';
        const trigrams = new Set();
        for (let i = 0; i < padded.length - 2; i++) trigrams.add(padded.substring(i, i + 3));
        return Array.from(trigrams);
      }

      function calculateSimilarity(t1, t2) {
        const s1 = new Set(t1 || []);
        const s2 = new Set(t2 || []);
        const inter = new Set([...s1].filter(x => s2.has(x)));
        const union = new Set([...s1, ...s2]);
        return union.size === 0 ? 0 : inter.size / union.size;
      }

      function searchSongs(query) {
        if (!query || query.length < 2) return [];
        const MIN_SIMILARITY = query.length <= 3 ? 0.12 : 0.10;
        const qTr = createPostgresStyleTrigrams(query);
        const res = [];
        Object.keys(songIndex).forEach(key => {
          const idx = songIndex[key];
          const titleSim = calculateSimilarity(qTr, idx.titleTrigrams);
          const lineSim = calculateSimilarity(qTr, idx.firstLineTrigrams);
          const combined = Math.max(titleSim * 1.2, lineSim);
          const nq = normalizeText(query);
          const nt = normalizeText(idx.title);
          if (nt.startsWith(nq) && nq.length >= 2) {
            res.push({ ...idx, similarity: Math.max(0.95, combined), titleMatch: true, songKey: key });
            return;
          }
          if (combined >= MIN_SIMILARITY) res.push({ ...idx, similarity: combined, titleMatch: titleSim > lineSim, songKey: key });
        });
        return res.sort((a, b) => b.similarity - a.similarity).slice(0, 10);
      }

      // --- DOM: results rendering (unchanged semantics) ---
      function displayResults(results) {
        const container = document.getElementById('searchResults');
        if (!results || results.length === 0) { container.style.display = 'none'; return; }
        container.innerHTML = '';
        currentResults = results.slice(0, 5);
        selectedIndex = 0;
        currentResults.forEach((r, i) => {
          const div = document.createElement('div');
          div.className = 'search-result-item';
          if (i === 0) div.classList.add('selected');
          const firstLineHtml = r.firstLine ? `<small style="color:#7a9a7a;font-size:0.85em;display:block;margin-top:4px">${r.firstLine}</small>` : '';
          div.innerHTML = `${r.displayTitle}${firstLineHtml}`;
          div.dataset.index = i;
          div.addEventListener('click', () => onSearchResultClick(r));
          div.addEventListener('mouseenter', () => { clearSelection(); selectedIndex = i; div.classList.add('selected'); });
          container.appendChild(div);
        });
        container.style.display = 'block';
      }

      function clearSelection() { document.querySelectorAll('.search-result-item').forEach(el => el.classList.remove('selected')); }

      function handleSearch() {
        const q = document.getElementById('searchInput').value.trim();
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (!q || q.length < 2) { document.getElementById('searchResults').style.display = 'none'; return; }
          const r = searchSongs(q);
          displayResults(r);
        }, 100);
      }

      function handleKeydown(e) {
        const container = document.getElementById('searchResults');
        if (e.key === 'Escape') { e.preventDefault(); clearSearch(); return; }
        if (e.key === 'Tab') { if (container.style.display !== 'none' && currentResults.length > 0) { e.preventDefault(); onSearchResultClick(currentResults[0]); } return; }
        if (container.style.display === 'none' || currentResults.length === 0) return;
        switch (e.key) {
          case 'ArrowDown': e.preventDefault(); moveSelection(1); break;
          case 'ArrowUp': e.preventDefault(); moveSelection(-1); break;
          case 'Enter': e.preventDefault(); if (selectedIndex >= 0 && selectedIndex < currentResults.length) onSearchResultClick(currentResults[selectedIndex]); break;
        }
      }

      function moveSelection(dir) {
        const items = document.querySelectorAll('.search-result-item'); if (items.length === 0) return; let ni = selectedIndex + dir; if (ni < 0) ni = 0; if (ni >= items.length) ni = items.length - 1; if (ni === selectedIndex) return; clearSelection(); selectedIndex = ni; if (items[selectedIndex]) { items[selectedIndex].classList.add('selected'); items[selectedIndex].scrollIntoView({ block: 'nearest' }); }
      }

      function hideResults() { document.getElementById('searchResults').style.display = 'none'; selectedIndex = -1; currentResults = []; }
      function clearSearch() { const si = document.getElementById('searchInput'); si.value = ''; hideResults(); si.focus(); }

      function onSearchResultClick(result) {
        // Add to playlist instead of clearing only
        addSongToCurrentPlaylist({ title: result.displayTitle, firstLine: result.firstLine || '', songKey: result.songKey });
        // show preview for that song
        showSongPreview(result.songKey);
        hideResults();
        const si = document.getElementById('searchInput'); si.value = '';
      }

      function selectSong(result) {
        // kept for backward compatibility
        showSongPreview(result.songKey || result.title);
      }

      function formatSongContent(songData) {
        let out = '';
        if (!songData) return out;
        songData.sections && songData.sections.forEach((section, si) => {
          section.slides && section.slides.forEach((slide) => { if (Array.isArray(slide)) slide.forEach(line => out += line + '\n'); });
          if (si < songData.sections.length - 1) out += '\n';
        });
        return out.trim();
      }

      function showSongPreview(songKey) {
        const data = songsData[songKey];
        const titleEl = document.getElementById('songDetailsTitle');
        const contentEl = document.getElementById('songDetailsContent');
        if (!data) { titleEl.textContent = 'Detail písně'; contentEl.innerHTML = '<div class="no-results">Vyberte píseň z výsledků vyhledávání pro zobrazení detailů</div>'; return; }
        titleEl.textContent = cleanTitleForDisplay(songKey);
        contentEl.innerHTML = `<div class="song-lyrics">${formatSongContent(data)}</div>`;
      }

      // --- Playlist management (in-memory + localStorage) ---
      function loadPlaylists() {
        try {
          const raw = localStorage.getItem(PLAYLISTS_KEY);
          playlists = raw ? JSON.parse(raw) : {};
        } catch (e) { playlists = {}; }
        // ensure at least one playlist exists
        if (!Object.keys(playlists).length) {
          const id = createNewPlaylist('Nový playlist');
          currentPlaylistId = id;
        } else {
          currentPlaylistId = Object.keys(playlists)[0];
        }
        renderPlaylistSelector();
        renderCurrentPlaylist();
      }

      function savePlaylists() { try { localStorage.setItem(PLAYLISTS_KEY, JSON.stringify(playlists)); } catch (e) { console.error('Failed to save playlists', e); } }

      function createNewPlaylist(name) {
        const id = 'pl_' + Date.now();
        playlists[id] = { id, name: name || 'Playlist', items: [] };
        savePlaylists();
        renderPlaylistSelector();
        currentPlaylistId = id;
        renderCurrentPlaylist();
        // focus the title element so user can rename immediately
        setTimeout(() => {
          const titleEl = document.getElementById('playlistTitle');
          const header = document.getElementById('playlistHeader');
          if (titleEl) {
            titleEl.textContent = playlists[id].name || '';
            if (header) header.classList.add('editing');
            try {
              titleEl.focus();
              const range = document.createRange();
              range.selectNodeContents(titleEl);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            } catch (err) {}
          }
        }, 60);
        // announce creation for screen readers
        try {
          const ariaLive = document.getElementById('ariaLive');
          if (ariaLive) ariaLive.textContent = 'Vytvořen playlist ' + (playlists[id].name || '');
        } catch (e) {}
        return id;
      }

      function deleteCurrentPlaylist() {
        if (!currentPlaylistId) return;
        if (!confirm('Smazat tento playlist?')) return;
        const deletedName = playlists[currentPlaylistId] ? playlists[currentPlaylistId].name : '';
        delete playlists[currentPlaylistId];
        const keys = Object.keys(playlists);
        currentPlaylistId = keys.length ? keys[0] : createNewPlaylist('Nový playlist');
        savePlaylists();
        renderPlaylistSelector();
        renderCurrentPlaylist();
        // announce deletion
        try {
          const ariaLive = document.getElementById('ariaLive');
          if (ariaLive) ariaLive.textContent = 'Playlist smazán: ' + deletedName;
        } catch (e) {}
      }

      function renderPlaylistSelector() {
        const sel = document.getElementById('playlistSelect');
        sel.innerHTML = '';
        Object.keys(playlists).forEach(id => {
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = playlists[id].name || 'Playlist';
          if (id === currentPlaylistId) opt.selected = true;
          sel.appendChild(opt);
        });
      }

      function onPlaylistSelectChange(e) {
        currentPlaylistId = e.target.value;
        renderCurrentPlaylist();
      }

      function renderCurrentPlaylist() {
        const container = document.getElementById('playlistItems');
        const titleEl = document.getElementById('playlistTitle');
        container.innerHTML = '';
        container.setAttribute('role', 'list');
        if (!currentPlaylistId || !playlists[currentPlaylistId]) { titleEl.textContent = 'Nový playlist'; return; }
        const pl = playlists[currentPlaylistId];
        titleEl.textContent = pl.name || 'Playlist';
        // ensure header is not left accidentally in editing mode
        const header = document.getElementById('playlistHeader');
        if (header) header.classList.remove('editing');
        pl.items.forEach((it, idx) => {
          const row = document.createElement('div');
          row.className = 'playlist-item';
          row.setAttribute('role', 'listitem');
          row.draggable = true;

          const handle = document.createElement('div');
          handle.className = 'drag-handle';
          handle.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          handle.title = 'Táhnout pro přesunutí';

          const a = document.createElement('a');
          a.href = '#';
          a.setAttribute('tabindex', '0');
          a.setAttribute('aria-label', (it.title || '') + (it.firstLine ? ' — ' + it.firstLine : ''));
          a.innerHTML = `<strong>${it.title}</strong>${it.firstLine ? '<small>' + it.firstLine + '</small>' : ''}`;
          a.addEventListener('click', (ev) => { ev.preventDefault(); showSongPreview(it.songKey); });
          a.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); showSongPreview(it.songKey); } });

          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-item';
          removeBtn.title = 'Odstranit';
          removeBtn.setAttribute('aria-label', 'Odstranit položku');
          removeBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          removeBtn.addEventListener('click', () => { removeItemFromPlaylist(idx); });

          row.appendChild(handle);
          row.appendChild(a);
          row.appendChild(removeBtn);
          // if this row corresponds to the last moved item, add moved class briefly
          if (lastMovedKey && it.songKey === lastMovedKey) {
            row.classList.add('moved');
            // clear the marker after the animation ends
            row.addEventListener('animationend', () => { row.classList.remove('moved'); lastMovedKey = null; }, { once: true });
          }
          container.appendChild(row);

          // drag events with visual insert cue
          row.addEventListener('dragstart', (e) => {
            dragSrcIndex = idx;
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            try { e.dataTransfer.setData('text/plain', String(idx)); } catch (err) {}
          });

          row.addEventListener('dragend', (e) => {
            dragSrcIndex = null;
            // clear all drop cues
            document.querySelectorAll('.playlist-item.drop-before, .playlist-item.drop-after').forEach(el => el.classList.remove('drop-before', 'drop-after'));
            row.classList.remove('dragging');
          });

          row.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            // compute whether we should show before or after based on mouse position
            const rect = row.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const isBefore = (e.clientY < midY);
            // clear cues on all rows first
            document.querySelectorAll('.playlist-item.drop-before, .playlist-item.drop-after').forEach(el => el.classList.remove('drop-before', 'drop-after'));
            if (isBefore) row.classList.add('drop-before'); else row.classList.add('drop-after');
          });

          row.addEventListener('dragleave', (e) => { row.classList.remove('drag-over', 'drop-before', 'drop-after'); });

          row.addEventListener('drop', (e) => {
            e.preventDefault();
            row.classList.remove('drag-over');
            const from = dragSrcIndex !== null ? dragSrcIndex : parseInt((e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/plain')) || -1, 10);
            if (from === -1) return;
            const rect = row.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const insertBefore = (e.clientY < midY);
            const pl = playlists[currentPlaylistId];
            const moved = pl.items.splice(from, 1)[0];
            let insertAt = idx;
            // if inserting after the target, and source was before, adjust index
            if (!insertBefore) insertAt = idx + 1;
            if (from < insertAt) insertAt--; // account for removal shifting indexes
            pl.items.splice(insertAt, 0, moved);
            savePlaylists();
            // remember key for visual feedback
            lastMovedKey = moved.songKey || null;
            renderCurrentPlaylist();
          });
        });
      }

      function addSongToCurrentPlaylist(item) {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        // dedupe by songKey: if exists, move it to the end and show preview
        const pl = playlists[currentPlaylistId];
        const existingIdx = pl.items.findIndex(i => i.songKey === item.songKey);
          if (existingIdx !== -1) {
            // move it to the end
            const existing = pl.items.splice(existingIdx, 1)[0];
            pl.items.push(existing);
            savePlaylists();
            // remember key for visual feedback
            lastMovedKey = existing.songKey || null;
            renderCurrentPlaylist();
            // show the preview for the existing item
            showSongPreview(item.songKey);
            // announce moved to end
            try { const ariaLive = document.getElementById('ariaLive'); if (ariaLive) ariaLive.textContent = 'Položka přesunuta na konec playlistu'; } catch (e) {}
            return;
          }
          // append new item to the end
          pl.items.push(item);
          // keep playlist reasonably bounded (optional limit 200) - remove oldest items from start
          while (pl.items.length > 200) pl.items.shift();
          savePlaylists();
          // mark newly added item for feedback
          lastMovedKey = item.songKey || null;
          renderCurrentPlaylist();
          // announce addition
          try { const ariaLive = document.getElementById('ariaLive'); if (ariaLive) ariaLive.textContent = 'Přidána položka: ' + (item.title || ''); } catch (e) {}
      }

      function removeItemFromPlaylist(index) {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        const removed = playlists[currentPlaylistId].items[index];
        playlists[currentPlaylistId].items.splice(index, 1);
        savePlaylists();
        renderCurrentPlaylist();
        try { const ariaLive = document.getElementById('ariaLive'); if (ariaLive) ariaLive.textContent = 'Položka odstraněna: ' + (removed ? (removed.title || '') : ''); } catch (e) {}
      }

      function clearPlaylist() {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        if (!confirm('Vymazat všechny položky v playlistu?')) return;
        playlists[currentPlaylistId].items = [];
        savePlaylists();
        renderCurrentPlaylist();
        try { const ariaLive = document.getElementById('ariaLive'); if (ariaLive) ariaLive.textContent = 'Playlist vyprázdněn'; } catch (e) {}
      }

      // --- setup event listeners ---
      function setupEventListeners() {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('searchClearBtn');
        const sel = document.getElementById('playlistSelect');
        const newBtn = document.getElementById('newPlaylistBtn');
        const delBtn = document.getElementById('deletePlaylistBtn');
        const clearPlBtn = document.getElementById('clearPlaylistBtn');
        const combo = document.querySelector('.playlist-combo');
        const openBtn = document.getElementById('openPlaylistSelectBtn');
        const titleElEditable = document.getElementById('playlistTitle');
        const header = document.getElementById('playlistHeader');
        const ariaLive = document.getElementById('ariaLive');

        // Search input handlers
        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('keydown', handleKeydown);
        clearBtn.addEventListener('click', clearSearch);
        document.addEventListener('click', (ev) => { if (!ev.target.closest('.search-container')) hideResults(); });

        // Playlist actions
        sel.addEventListener('change', (e) => { onPlaylistSelectChange(e); closeCombo(); });
        newBtn.addEventListener('click', () => createNewPlaylist('Nový playlist'));
        delBtn.addEventListener('click', deleteCurrentPlaylist);
        clearPlBtn.addEventListener('click', clearPlaylist);

        // Combo helpers
        function openCombo() {
          if (!sel || !combo) return;
          const opts = sel.options ? sel.options.length : 0;
          if (opts <= 1) return;
          sel.setAttribute('data-temp-open', 'true');
          sel.size = Math.min(8, opts);
          openBtn && openBtn.setAttribute('aria-expanded', 'true');
          // make the native list visible and focusable
          setTimeout(() => { try { sel.focus(); } catch (err) {} }, 10);
          // listen for outside clicks
          document.addEventListener('click', outsideClickListener);
        }
        function closeCombo() {
          if (!sel) return;
          sel.removeAttribute('data-temp-open');
          try { sel.size = 1; } catch (err) {}
          openBtn && openBtn.setAttribute('aria-expanded', 'false');
          document.removeEventListener('click', outsideClickListener);
        }
        function outsideClickListener(e) {
          if (!e.target.closest('.playlist-combo')) closeCombo();
        }

        // Toggle button
        if (openBtn) {
          openBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = openBtn.getAttribute('aria-expanded') === 'true';
            if (expanded) closeCombo(); else openCombo();
          });
        }

        // Keyboard: ArrowDown opens the combo when focused on title
        titleElEditable && titleElEditable.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowDown') { e.preventDefault(); openCombo(); }
          if (e.key === 'Enter') { e.preventDefault(); closePlaylistTitleEditor(false); }
          if (e.key === 'Escape') { e.preventDefault(); closePlaylistTitleEditor(true); }
        });

        // Ensure Escape collapses the select when it's open
        sel && sel.addEventListener('keydown', (e) => { if (e.key === 'Escape') { e.preventDefault(); closeCombo(); sel.blur(); } });

        // Contenteditable rename editor (double-click to edit for safety)
        let prevName = null;
        function openPlaylistTitleEditor() {
          if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
          header.classList.add('editing');
          prevName = playlists[currentPlaylistId].name || '';
          try { titleElEditable.focus(); const range = document.createRange(); range.selectNodeContents(titleElEditable); const selRange = window.getSelection(); selRange.removeAllRanges(); selRange.addRange(range); } catch (err) {}
        }
        function closePlaylistTitleEditor(cancel) {
          header.classList.remove('editing');
          titleElEditable.blur();
          if (cancel) {
            if (currentPlaylistId && playlists[currentPlaylistId]) titleElEditable.textContent = playlists[currentPlaylistId].name || '';
            ariaLive.textContent = 'Přejmenování zrušeno';
            return;
          }
          const newName = (titleElEditable.textContent || '').trim() || 'Playlist';
          if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
          const prev = playlists[currentPlaylistId].name;
          if (newName === prev) { ariaLive.textContent = 'Název nezměněn'; return; }
          const duplicate = Object.keys(playlists).some(id => id !== currentPlaylistId && (playlists[id].name || '') === newName);
          if (duplicate) { alert('Název playlistu již existuje'); openPlaylistTitleEditor(); return; }
          playlists[currentPlaylistId].name = newName; savePlaylists(); renderPlaylistSelector(); renderCurrentPlaylist(); ariaLive.textContent = 'Playlist přejmenován na ' + newName;
        }

        // Interactions: double-click title to edit; single-click title focuses component
        titleElEditable && titleElEditable.addEventListener('dblclick', (e) => { e.stopPropagation(); openPlaylistTitleEditor(); });
        titleElEditable && titleElEditable.addEventListener('click', (e) => { e.stopPropagation(); /* do not auto-edit on single click */ });
        titleElEditable && titleElEditable.addEventListener('blur', () => { closePlaylistTitleEditor(false); });

        // close combo when an option is selected (handled above) and when select loses focus
        sel && sel.addEventListener('blur', () => { closeCombo(); });

        // focus shortcuts
        document.addEventListener('keydown', (e) => {
          const active = document.activeElement;
          const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable);
          if (isTyping) return;
          if (e.key === '/' && !e.metaKey && !e.ctrlKey) { e.preventDefault(); try { searchInput.focus(); searchInput.select(); } catch (err) {} }
          if ((e.key && e.key.toLowerCase() === 'k') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); try { searchInput.focus(); searchInput.select(); } catch (err) {} }
        });
      }

      function debounce(fn, wait) {
        let t = null;
        return function() { clearTimeout(t); t = setTimeout(() => fn.apply(this, arguments), wait); };
      }

      document.addEventListener('DOMContentLoaded', async () => {
        await loadSongsData();
        loadPlaylists();
        setupEventListeners();
        // autofocus attempts
        const input = document.getElementById('searchInput');
        if (input) { try { input.focus(); setTimeout(() => { try { input.focus(); input.select && input.select(); } catch (e) {} }, 50); } catch (e) {} }
      });
    </script>
  </body>
</html>
