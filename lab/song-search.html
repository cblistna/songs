<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vyhled√°v√°n√≠ p√≠sn√≠</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        min-height: 100vh;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        color: #2d5a2d;
        font-size: clamp(1.8rem, 4vw, 2.5rem);
        margin-bottom: 10px;
        font-weight: 600;
      }

      .header p {
        color: #5a7a5a;
        font-size: clamp(1rem, 2vw, 1.1rem);
      }

      .search-container {
        position: relative;
        margin-bottom: 30px;
        width: 66.666%;
        margin-left: auto;
        margin-right: auto;
      }

 .search-input {
            width: 100%;
            padding: 18px 24px;
            font-size: clamp(1rem, 2vw, 1.2rem);
            border: 3px solid #c4d9c4;
            border-radius: 16px;
            background: #ffffff;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(45, 90, 45, 0.1);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 48px;
        }

      .search-input:focus {
        border-color: #ff9966;
        box-shadow: 0 0 0 4px rgba(255, 153, 102, 0.2),
          0 4px 12px rgba(45, 90, 45, 0.15);
        transform: translateY(-1px);
      }

      .search-input::placeholder {
        color: #8fb48f;
      }

 .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 3px solid #c4d9c4;
            border-top: none;
            border-radius: 0 0 16px 16px;
            max-height: calc(84px * 5);
            overflow-y: auto; /* remains scrollable when more than 5 results */
            overflow-x: hidden;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 24px rgba(45, 90, 45, 0.15);
            /* visually hide scrollbar while keeping scrolling usable */
            -ms-overflow-style: none; /* IE 10+ */
            scrollbar-width: none; /* Firefox */
        }
        .search-results::-webkit-scrollbar { display: none; }
        .search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #7a9a7a;
            padding: 6px 8px;
        }
        .search-clear:focus { outline: none; }

      .search-result-item {
        padding: 18px 24px;
        min-height: 56px;
        cursor: pointer;
        border-bottom: 1px solid #f0f8f0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        color: #2d5a2d;
        font-size: 1rem;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .search-result-item:hover,
      .search-result-item.selected {
        background: linear-gradient(135deg, #ff9966, #ffb399);
        color: white;
        transform: translateX(4px);
      }

      .search-result-item:hover small,
      .search-result-item.selected small {
        color: rgba(255, 255, 255, 0.8) !important;
      }

      .search-result-item:last-child {
        border-bottom: none;
      }

      .song-details {
        background: #ffffff;
        border: 3px solid #c4d9c4;
        border-radius: 16px;
        padding: 24px;
        min-height: 200px;
        box-shadow: 0 4px 16px rgba(45, 90, 45, 0.1);
        transition: all 0.3s ease;
      }

      .song-details:hover {
        box-shadow: 0 6px 20px rgba(45, 90, 45, 0.15);
      }

      .song-details h2 {
        color: #2d5a2d;
        margin-bottom: 5px;
        font-size: clamp(1.2rem, 3vw, 1.5rem);
        font-weight: 600;
      }

      .song-lyrics {
        background: #ffffff;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: clamp(0.9rem, 1.8vw, 1rem);
        line-height: 1.6;
        color: #2d5a2d;
        white-space: pre-line;
        text-align: left;
      }

      .no-results {
        text-align: center;
        color: #7a9a7a;
        font-style: italic;
        padding: 60px 20px;
        font-size: clamp(1rem, 2vw, 1.1rem);
      }

      @media (max-width: 768px) {
        body {
          padding: 15px;
        }

        .container {
          max-width: 100%;
        }

        .search-container {
          width: 100%;
          margin-left: 0;
          margin-right: 0;
        }

        .search-input {
          padding: 15px 20px;
        }

        .search-result-item {
          padding: 14px 20px;
        }

        .song-details {
          padding: 20px;
        }

        .song-lyrics {
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .header {
          margin-bottom: 30px;
        }

        .search-input {
          padding: 12px 16px;
        }

        .search-result-item {
          padding: 12px 16px;
        }

        .song-details {
          padding: 16px;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .search-results {
        animation: fadeIn 0.3s ease;
      }

      .search-input:focus-visible {
        outline: 3px solid #ff9966;
        outline-offset: 2px;
      }

      .search-result-item:focus {
        outline: 2px solid #ff9966;
        outline-offset: -2px;
      }

      /* Playlist & two-column layout */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        align-items: start;
        margin-top: 20px;
      }

      .playlist-panel {
        width: 100%;
      }

      .right-panel {
        width: 100%;
      }

      .playlist-manager {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        align-items: center;
      }

      .playlist-manager select {
        flex: 1 1 auto;
        padding: 8px 10px;
        border-radius: 8px;
        border: 2px solid #c4d9c4;
        background: #fff;
      }

      .playlist-manager button {
        padding: 8px 10px;
        border-radius: 8px;
        border: none;
        background: #ff9966;
        color: white;
        cursor: pointer;
      }

      .playlist-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      #playlistTitle {
        font-size: 1rem;
        font-weight: 600;
        color: #2d5a2d;
        padding: 6px 8px;
        border-radius: 8px;
        min-width: 0;
        outline: none;
        border: 2px solid transparent;
      }

      #playlistTitle[contenteditable]:focus {
        border-color: #ff9966;
      }

      .playlist-items {
        background: #ffffff;
        border: 3px solid #c4d9c4;
        border-radius: 12px;
        max-height: calc(84px * 5);
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      .playlist-items::-webkit-scrollbar { display: none; }

      .playlist-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-bottom: 1px solid #f0f8f0;
        gap: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .playlist-item a {
        color: #2d5a2d;
        text-decoration: none;
        flex: 1 1 auto;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
      }

      .playlist-item small {
        display: block;
        color: #7a9a7a;
        font-size: 0.85em;
      }

      .playlist-item button.remove-item {
        margin-left: 8px;
        background: transparent;
        border: none;
        color: #7a9a7a;
        cursor: pointer;
        font-size: 16px;
      }

      @media (max-width: 768px) {
        .main-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéµ Vyhled√°v√°n√≠ p√≠sn√≠</h1>
      </div>

        <div class="main-grid">
          <div class="playlist-panel">
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Zadejte alespo≈à 2 znaky pro vyhled√°n√≠ p√≠sn√≠..."
                    autocomplete="off"
                    autofocus
                >
                <button id="searchClearBtn" class="search-clear" aria-label="Clear search">‚úï</button>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="playlist-manager">
              <select id="playlistSelect" aria-label="Select playlist"></select>
              <button id="newPlaylistBtn" title="New playlist">New</button>
              <button id="deletePlaylistBtn" title="Delete playlist">Del</button>
            </div>

            <div class="playlist-header">
              <div id="playlistTitle" contenteditable="true" aria-label="Playlist title">Nov√Ω playlist</div>
              <button id="clearPlaylistBtn" title="Clear playlist">Clear</button>
            </div>

            <div id="playlistItems" class="playlist-items">
              <!-- playlist entries go here -->
            </div>
          </div>

          <div class="right-panel">
            <div class="song-details">
              <h2 id="songDetailsTitle">Detail p√≠snƒõ</h2>
              <div id="songDetailsContent" class="no-results">
                Vyberte p√≠se≈à z v√Ωsledk≈Ø vyhled√°v√°n√≠ pro zobrazen√≠ detail≈Ø
              </div>
            </div>
          </div>
        </div>
    </div>

    <script>
      // Songs, index and search state
      let songsData = {};
      let songIndex = {};
      let searchTimeout = null;
      let selectedIndex = -1;
      let currentResults = [];

      // Playlist state
      const PLAYLISTS_KEY = 'song_lab_playlists_v1';
      let playlists = {}; // id -> { id, name, items: [{title, firstLine, songKey}] }
      let currentPlaylistId = null;

      function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }

      async function loadSongsData() {
        try {
          const response = await fetch('songs.json');
          songsData = await response.json();

          songIndex = {};
          Object.keys(songsData).forEach((title) => {
            const firstLine = getFirstLine(songsData[title]);
            songIndex[title] = {
              title: title,
              displayTitle: cleanTitleForDisplay(title),
              firstLine: firstLine,
              titleTrigrams: createPostgresStyleTrigrams(title),
              firstLineTrigrams: createPostgresStyleTrigrams(firstLine),
              data: songsData[title]
            };
          });

          console.log('Songs data loaded:', Object.keys(songsData).length);
        } catch (err) {
          console.error('Error loading songs.json', err);
          document.getElementById('songDetailsContent').innerHTML = '<div class="no-results">Chyba p≈ôi naƒç√≠t√°n√≠ dat p√≠sn√≠. Zkontrolujte, zda existuje soubor songs.json.</div>';
        }
      }

      function normalizeText(text) {
        return removeAccents(text || '').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
      }

      function cleanTitleForDisplay(title) {
        const idx = title.indexOf(';');
        if (idx !== -1) return title.substring(0, idx).trim();
        return title;
      }

      function getFirstLine(songData) {
        if (!songData) return '';
        if (!songData.sections || !Array.isArray(songData.sections) || songData.sections.length === 0) return '';
        const firstSection = songData.sections[0];
        if (!firstSection.slides || !Array.isArray(firstSection.slides) || firstSection.slides.length === 0) return '';
        const firstSlide = firstSection.slides[0];
        if (!Array.isArray(firstSlide) || firstSlide.length === 0) return '';
        return firstSlide[0];
      }

      function createPostgresStyleTrigrams(text) {
        const normalized = normalizeText(text);
        const padded = '  ' + normalized + ' ';
        const trigrams = new Set();
        for (let i = 0; i < padded.length - 2; i++) trigrams.add(padded.substring(i, i + 3));
        return Array.from(trigrams);
      }

      function calculateSimilarity(t1, t2) {
        const s1 = new Set(t1 || []);
        const s2 = new Set(t2 || []);
        const inter = new Set([...s1].filter(x => s2.has(x)));
        const union = new Set([...s1, ...s2]);
        return union.size === 0 ? 0 : inter.size / union.size;
      }

      function searchSongs(query) {
        if (!query || query.length < 2) return [];
        const MIN_SIMILARITY = query.length <= 3 ? 0.12 : 0.10;
        const qTr = createPostgresStyleTrigrams(query);
        const res = [];
        Object.keys(songIndex).forEach(key => {
          const idx = songIndex[key];
          const titleSim = calculateSimilarity(qTr, idx.titleTrigrams);
          const lineSim = calculateSimilarity(qTr, idx.firstLineTrigrams);
          const combined = Math.max(titleSim * 1.2, lineSim);
          const nq = normalizeText(query);
          const nt = normalizeText(idx.title);
          if (nt.startsWith(nq) && nq.length >= 2) {
            res.push({ ...idx, similarity: Math.max(0.95, combined), titleMatch: true, songKey: key });
            return;
          }
          if (combined >= MIN_SIMILARITY) res.push({ ...idx, similarity: combined, titleMatch: titleSim > lineSim, songKey: key });
        });
        return res.sort((a, b) => b.similarity - a.similarity).slice(0, 10);
      }

      // --- DOM: results rendering (unchanged semantics) ---
      function displayResults(results) {
        const container = document.getElementById('searchResults');
        if (!results || results.length === 0) { container.style.display = 'none'; return; }
        container.innerHTML = '';
        currentResults = results.slice(0, 5);
        selectedIndex = 0;
        currentResults.forEach((r, i) => {
          const div = document.createElement('div');
          div.className = 'search-result-item';
          if (i === 0) div.classList.add('selected');
          const firstLineHtml = r.firstLine ? `<small style="color:#7a9a7a;font-size:0.85em;display:block;margin-top:4px">${r.firstLine}</small>` : '';
          div.innerHTML = `${r.displayTitle}${firstLineHtml}`;
          div.dataset.index = i;
          div.addEventListener('click', () => onSearchResultClick(r));
          div.addEventListener('mouseenter', () => { clearSelection(); selectedIndex = i; div.classList.add('selected'); });
          container.appendChild(div);
        });
        container.style.display = 'block';
      }

      function clearSelection() { document.querySelectorAll('.search-result-item').forEach(el => el.classList.remove('selected')); }

      function handleSearch() {
        const q = document.getElementById('searchInput').value.trim();
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          if (!q || q.length < 2) { document.getElementById('searchResults').style.display = 'none'; return; }
          const r = searchSongs(q);
          displayResults(r);
        }, 100);
      }

      function handleKeydown(e) {
        const container = document.getElementById('searchResults');
        if (e.key === 'Escape') { e.preventDefault(); clearSearch(); return; }
        if (e.key === 'Tab') { if (container.style.display !== 'none' && currentResults.length > 0) { e.preventDefault(); onSearchResultClick(currentResults[0]); } return; }
        if (container.style.display === 'none' || currentResults.length === 0) return;
        switch (e.key) {
          case 'ArrowDown': e.preventDefault(); moveSelection(1); break;
          case 'ArrowUp': e.preventDefault(); moveSelection(-1); break;
          case 'Enter': e.preventDefault(); if (selectedIndex >= 0 && selectedIndex < currentResults.length) onSearchResultClick(currentResults[selectedIndex]); break;
        }
      }

      function moveSelection(dir) {
        const items = document.querySelectorAll('.search-result-item'); if (items.length === 0) return; let ni = selectedIndex + dir; if (ni < 0) ni = 0; if (ni >= items.length) ni = items.length - 1; if (ni === selectedIndex) return; clearSelection(); selectedIndex = ni; if (items[selectedIndex]) { items[selectedIndex].classList.add('selected'); items[selectedIndex].scrollIntoView({ block: 'nearest' }); }
      }

      function hideResults() { document.getElementById('searchResults').style.display = 'none'; selectedIndex = -1; currentResults = []; }
      function clearSearch() { const si = document.getElementById('searchInput'); si.value = ''; hideResults(); si.focus(); }

      function onSearchResultClick(result) {
        // Add to playlist instead of clearing only
        addSongToCurrentPlaylist({ title: result.displayTitle, firstLine: result.firstLine || '', songKey: result.songKey });
        // show preview for that song
        showSongPreview(result.songKey);
        hideResults();
        const si = document.getElementById('searchInput'); si.value = '';
      }

      function selectSong(result) {
        // kept for backward compatibility
        showSongPreview(result.songKey || result.title);
      }

      function formatSongContent(songData) {
        let out = '';
        if (!songData) return out;
        songData.sections && songData.sections.forEach((section, si) => {
          section.slides && section.slides.forEach((slide) => { if (Array.isArray(slide)) slide.forEach(line => out += line + '\n'); });
          if (si < songData.sections.length - 1) out += '\n';
        });
        return out.trim();
      }

      function showSongPreview(songKey) {
        const data = songsData[songKey];
        const titleEl = document.getElementById('songDetailsTitle');
        const contentEl = document.getElementById('songDetailsContent');
        if (!data) { titleEl.textContent = 'Detail p√≠snƒõ'; contentEl.innerHTML = '<div class="no-results">Vyberte p√≠se≈à z v√Ωsledk≈Ø vyhled√°v√°n√≠ pro zobrazen√≠ detail≈Ø</div>'; return; }
        titleEl.textContent = cleanTitleForDisplay(songKey);
        contentEl.innerHTML = `<div class="song-lyrics">${formatSongContent(data)}</div>`;
      }

      // --- Playlist management (in-memory + localStorage) ---
      function loadPlaylists() {
        try {
          const raw = localStorage.getItem(PLAYLISTS_KEY);
          playlists = raw ? JSON.parse(raw) : {};
        } catch (e) { playlists = {}; }
        // ensure at least one playlist exists
        if (!Object.keys(playlists).length) {
          const id = createNewPlaylist('Nov√Ω playlist');
          currentPlaylistId = id;
        } else {
          currentPlaylistId = Object.keys(playlists)[0];
        }
        renderPlaylistSelector();
        renderCurrentPlaylist();
      }

      function savePlaylists() { try { localStorage.setItem(PLAYLISTS_KEY, JSON.stringify(playlists)); } catch (e) { console.error('Failed to save playlists', e); } }

      function createNewPlaylist(name) {
        const id = 'pl_' + Date.now();
        playlists[id] = { id, name: name || 'Playlist', items: [] };
        savePlaylists();
        renderPlaylistSelector();
        currentPlaylistId = id;
        renderCurrentPlaylist();
        return id;
      }

      function deleteCurrentPlaylist() {
        if (!currentPlaylistId) return;
        if (!confirm('Smazat tento playlist?')) return;
        delete playlists[currentPlaylistId];
        const keys = Object.keys(playlists);
        currentPlaylistId = keys.length ? keys[0] : createNewPlaylist('Nov√Ω playlist');
        savePlaylists();
        renderPlaylistSelector();
        renderCurrentPlaylist();
      }

      function renderPlaylistSelector() {
        const sel = document.getElementById('playlistSelect');
        sel.innerHTML = '';
        Object.keys(playlists).forEach(id => {
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = playlists[id].name || 'Playlist';
          if (id === currentPlaylistId) opt.selected = true;
          sel.appendChild(opt);
        });
      }

      function onPlaylistSelectChange(e) {
        currentPlaylistId = e.target.value;
        renderCurrentPlaylist();
      }

      function renderCurrentPlaylist() {
        const container = document.getElementById('playlistItems');
        const titleEl = document.getElementById('playlistTitle');
        container.innerHTML = '';
        if (!currentPlaylistId || !playlists[currentPlaylistId]) { titleEl.textContent = 'Nov√Ω playlist'; return; }
        const pl = playlists[currentPlaylistId];
        titleEl.textContent = pl.name || 'Playlist';
        pl.items.forEach((it, idx) => {
          const row = document.createElement('div');
          row.className = 'playlist-item';
          const a = document.createElement('a');
          a.href = '#';
          a.innerHTML = `<strong>${it.title}</strong>${it.firstLine ? '<small>' + it.firstLine + '</small>' : ''}`;
          a.addEventListener('click', (ev) => { ev.preventDefault(); showSongPreview(it.songKey); });
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-item';
          removeBtn.title = 'Remove';
          removeBtn.innerHTML = '‚úï';
          removeBtn.addEventListener('click', () => { removeItemFromPlaylist(idx); });
          row.appendChild(a);
          row.appendChild(removeBtn);
          container.appendChild(row);
        });
      }

      function addSongToCurrentPlaylist(item) {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        playlists[currentPlaylistId].items.push(item);
        savePlaylists();
        renderCurrentPlaylist();
      }

      function removeItemFromPlaylist(index) {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        playlists[currentPlaylistId].items.splice(index, 1);
        savePlaylists();
        renderCurrentPlaylist();
      }

      function clearPlaylist() {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        if (!confirm('Vymazat v≈°echny polo≈æky v playlistu?')) return;
        playlists[currentPlaylistId].items = [];
        savePlaylists();
        renderCurrentPlaylist();
      }

      function onPlaylistTitleEdit(e) {
        if (!currentPlaylistId || !playlists[currentPlaylistId]) return;
        playlists[currentPlaylistId].name = e.target.textContent.trim() || 'Playlist';
        savePlaylists();
        renderPlaylistSelector();
      }

      // --- setup event listeners ---
      function setupEventListeners() {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('searchClearBtn');
        const sel = document.getElementById('playlistSelect');
        const newBtn = document.getElementById('newPlaylistBtn');
        const delBtn = document.getElementById('deletePlaylistBtn');
        const clearPlBtn = document.getElementById('clearPlaylistBtn');
        const titleEl = document.getElementById('playlistTitle');

        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('keydown', handleKeydown);
        clearBtn.addEventListener('click', clearSearch);
        document.addEventListener('click', (ev) => { if (!ev.target.closest('.search-container')) hideResults(); });

        sel.addEventListener('change', onPlaylistSelectChange);
        newBtn.addEventListener('click', () => createNewPlaylist('Nov√Ω playlist'));
        delBtn.addEventListener('click', deleteCurrentPlaylist);
        clearPlBtn.addEventListener('click', clearPlaylist);
        titleEl.addEventListener('input', debounce(onPlaylistTitleEdit, 400));

        // focus shortcuts
        document.addEventListener('keydown', (e) => {
          const active = document.activeElement;
          const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable);
          if (isTyping) return;
          if (e.key === '/' && !e.metaKey && !e.ctrlKey) { e.preventDefault(); try { searchInput.focus(); searchInput.select(); } catch (err) {} }
          if ((e.key && e.key.toLowerCase() === 'k') && (e.ctrlKey || e.metaKey)) { e.preventDefault(); try { searchInput.focus(); searchInput.select(); } catch (err) {} }
        });
      }

      function debounce(fn, wait) {
        let t = null;
        return function() { clearTimeout(t); t = setTimeout(() => fn.apply(this, arguments), wait); };
      }

      document.addEventListener('DOMContentLoaded', async () => {
        await loadSongsData();
        loadPlaylists();
        setupEventListeners();
        // autofocus attempts
        const input = document.getElementById('searchInput');
        if (input) { try { input.focus(); setTimeout(() => { try { input.focus(); input.select && input.select(); } catch (e) {} }, 50); } catch (e) {} }
      });
    </script>
  </body>
</html>
